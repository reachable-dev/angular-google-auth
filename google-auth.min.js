"use strict";angular.module("jackrabbitsgroup.angular-google-auth",[]).factory("jrgGoogleAuth",["$rootScope","$http","$q",function($rootScope,$http,$q){var self={init:function(params){this.setGoogleOpts(params)},setGoogleOpts:function(params){var ii;if(params.client_id){googleInfo.client_id=params.client_id}googleInfo.scope="https://www.google.com/m8/feeds"},destroy:function(params){googleInfo={client_id:false,scope:"https://www.googleapis.com/auth/plus.login"};token={};inited=false},login:function(params){var self1=this;var config={scope:googleInfo.scope,client_id:googleInfo.client_id};gapi.auth.authorize(config,function(){var googleToken=gapi.auth.getToken();token=googleToken;params.returnVals={token:googleToken};if(params.extraInfo!==undefined&&params.extraInfo.user_id||params.extraInfo.emails){$http.defaults.headers.common["X-Requested-With"]=undefined;var url="https://www.googleapis.com/plus/v1/people/me"+"?access_token="+encodeURIComponent(googleToken.access_token);$http.get(url).success(function(data){params.returnVals.extraInfo={user_id:data.id};if(params.extraInfo.emails){params.returnVals.extraInfo.emails=false;if(data.emails!==undefined){params.returnVals.extraInfo.emails=data.emails;loginCallback(params)}else{var promise=self1.getContacts({emailOnly:true});promise.then(function(data){params.returnVals.extraInfo.emails=[{value:data.email,type:"",primary:true}];loginCallback(params)},function(data){loginCallback(params)})}}else{loginCallback(params)}}).error(function(data){console.log("error retrieving Google info");loginCallback(params)})}else{loginCallback(params)}if(!$rootScope.$$phase){$rootScope.$apply()}})},getContacts:function(opts){if(!opts){opts={}}var deferred=$q.defer();var googleToken=token;var maxResults=3e3;if(opts.emailOnly){maxResults=1}$http.defaults.headers.common["X-Requested-With"]=undefined;var url="https://www.google.com/m8/feeds/contacts/default/full"+"?access_token="+encodeURIComponent(googleToken.access_token)+"&alt=json&max-results="+maxResults;$http.get(url).success(function(data){if(opts.emailOnly){deferred.resolve({email:data.feed.id.$t})}else{var ii,vals,tempVal;var contacts=[];for(ii=0;ii<data.feed.entry.length;ii++){vals={email:false,name:false,phone:false};if(data.feed.entry[ii].gd$email){tempVal=pullPrimary(data.feed.entry[ii].gd$email,{valueKey:"address"});if(tempVal){vals.email=tempVal}}if(data.feed.entry[ii].gd$phoneNumber){tempVal=pullPrimary(data.feed.entry[ii].gd$phoneNumber,{valueKey:"$t"});if(tempVal){vals.phone=tempVal}}if(data.feed.entry[ii].title){vals.name=data.feed.entry[ii].title.$t}contacts[ii]=vals}deferred.resolve({contacts:contacts})}}).error(function(data){var msg="error retrieving Google contacts";console.log(msg);deferred.reject({msg:msg})});return deferred.promise}};var inited=false;var token={};var googleInfo={client_id:false,scope:"https://www.googleapis.com/auth/plus.login"};var scopeMap={login:"https://www.googleapis.com/auth/plus.login",email:"https://www.googleapis.com/auth/userinfo.email https://www.google.com/m8/feeds",contacts:"https://www.google.com/m8/feeds"};function loginCallback(params){var ii;console.log(params);if(params.callback.args&&params.callback.args!==undefined){if(params.callback.args.length===undefined)params.callback.args=[params.callback.args]}else{params.callback.args=[]}var args=params.callback.args.concat([params.returnVals]);if(args.length==1){args=args[0]}$rootScope.$broadcast(params.callback.evtName,args);if(!$rootScope.$$phase){$rootScope.$apply()}}function pullPrimary(items,opts){var ii;var valueKey="value";var retVal=false;if(opts.valueKey){valueKey=opts.valueKey}var found=false;for(ii=0;ii<items.length;ii++){if(opts.matchKey!==undefined&&opts.matchVal!==undefined){if(items[ii][opts.matchKey]!==undefined&&items[ii][opts.matchKey]==opts.matchVal){retVal=items[ii][valueKey];found=true;break}}else{if(items[ii].primary||items[ii].primary=="true"){retVal=items[ii][valueKey];found=true;break}}}if(!found&&items.length>0){retVal=items[0][valueKey]}return retVal}return self}]);
